{% extends 'base.html' %}

{% block footer %}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Desmos API -->
<script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey={{ desmos_api_key }}"></script>

<div class="flex h-[calc(100vh-64px)] overflow-hidden">
    <!-- 左侧：历史记录 (可折叠或简化) -->
    <div class="w-64 bg-slate-50 border-r border-slate-200 hidden md:flex flex-col">
        <div class="p-4 border-b border-slate-200">
            <h2 class="font-bold text-slate-700">思考记录</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2">
            {% for c in user.conversations.all %}
                <div class="group flex items-center justify-between p-3 rounded-lg hover:bg-white hover:shadow-sm transition {% if c.id == conversation.id %}bg-white shadow-sm{% endif %}">
                    <a href="{% url 'chat_detail' c.id %}" class="block flex-1 text-sm text-slate-600 truncate {% if c.id == conversation.id %}font-medium text-indigo-600{% endif %}">
                        {{ c.topic|default:"新思考..." }}
                        <div class="text-xs text-slate-400 mt-1">{{ c.created_at|date:"m-d H:i" }}</div>
                    </a>
                    <button onclick="deleteConversation({{ c.id }}, event)" class="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- 拖拽上传覆盖层 -->
    <div id="drag-overlay" class="hidden fixed inset-0 bg-indigo-900/50 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center transform scale-100 transition-transform">
            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                <i class="ph-fill ph-upload-simple text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">松手上传图片</h3>
            <p class="text-slate-500">将图片拖放到此处即可发送</p>
        </div>
    </div>

    <!-- 中间：聊天区域 -->
    <div class="flex-1 flex flex-col bg-white relative h-full" id="drop-zone">
        <!-- 消息列表 -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
            <!-- 欢迎语 -->
            <div class="flex gap-4">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                    <i class="ph-fill ph-robot text-2xl"></i>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl rounded-tl-none max-w-2xl">
                    <p class="text-slate-700">你好，我是你的思考导师。今天有什么困扰你的问题？请直接告诉我，但请记住，我不会直接给你答案。</p>
                </div>
            </div>

            {% for interaction in interactions %}
                <!-- 用户侧消息 -->
                {% if interaction.type == 'question' or interaction.type == 'probe_answer' or interaction.type == 'user_interpretation' %}
                <div class="flex gap-4 flex-row-reverse">
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 flex-shrink-0">
                        <i class="ph-fill ph-user text-2xl"></i>
                    </div>
                    <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none max-w-2xl">
                        <p>{{ interaction.text_content }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- AI 侧消息 -->
                {% if interaction.type == 'ai_feedback' or interaction.type == 'ai_image' %}
                    <div class="flex gap-4">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                            <i class="ph-fill ph-robot text-2xl"></i>
                        </div>
                        <div class="bg-slate-100 p-4 rounded-2xl rounded-tl-none max-w-2xl">
                             {% if interaction.image_url %}
                                <div class="mb-4">
                                    <img src="{{ interaction.image_url }}" class="rounded-xl shadow-lg border border-indigo-100 max-w-full bg-slate-100 min-h-[200px]" loading="lazy" referrerpolicy="no-referrer" onload="scrollToBottom()">
                                </div>
                            {% endif %}
                            
                            {% if interaction.text_content %}
                                <div class="prose prose-slate break-words max-w-none prose-p:my-0 prose-headings:my-1 leading-normal ai-message-content">{{ interaction.text_content|safe }}</div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden flex gap-4">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                    <i class="ph-fill ph-robot text-2xl"></i>
                </div>
                <div class="bg-slate-100 p-4 rounded-2xl rounded-tl-none typing-indicator text-slate-500">
                    <span>.</span><span>.</span><span>.</span>
                </div>
            </div>
            
            <!-- 最终报告容器 -->
            <div id="final-review-container" class="hidden animate-fade-in">
                <!-- 动态插入 -->
            </div>
        </div>

        <!-- 底部输入区 -->
        <div class="border-t border-slate-200 bg-white p-4 w-full z-10 transition-transform duration-300 flex-shrink-0" id="input-area">
            <div class="max-w-4xl mx-auto">
                <!-- 工具栏 -->
                <div class="flex gap-2 mb-2">
                    <button onclick="switchTab('text')" id="tab-text" class="px-3 py-1 text-sm rounded-full bg-indigo-100 text-indigo-700 font-medium">文字</button>
                    <button onclick="switchTab('canvas')" id="tab-canvas" class="px-3 py-1 text-sm rounded-full hover:bg-slate-100 text-slate-600">画板</button>
                    <button onclick="toggleRecording()" id="btn-voice" class="px-3 py-1 text-sm rounded-full hover:bg-slate-100 text-slate-600 flex items-center gap-1">
                        <i class="ph ph-microphone"></i>
                        <span id="voice-text">语音</span>
                    </button>
                </div>

                <!-- 文本输入 -->
                <div id="input-text" class="block">
                    <div class="relative flex items-center gap-2">
                        <!-- Upload Button -->
                        <button onclick="document.getElementById('image-upload').click()" class="p-2 text-slate-500 hover:text-indigo-600 transition-colors" title="上传图片">
                            <i class="ph ph-image text-2xl"></i>
                        </button>
                        <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="previewImage(this)">

                        <textarea id="message-input" name="query" rows="1" 
                            class="block w-full rounded-full border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 pr-12 resize-none py-3 px-4" 
                            placeholder="输入你的想法... (Enter发送，Shift+Enter换行)" 
                            required 
                            style="min-height: 48px; max-height: 150px;"
                            onkeydown="handleChatKeydown(event)"></textarea>
                        <button onclick="sendMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Image Preview -->
                    <div id="image-preview-container" class="hidden mt-2 relative inline-block">
                        <img id="image-preview" class="h-20 w-20 object-cover rounded-lg border border-slate-200">
                        <button onclick="clearImagePreview()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm">
                            <i class="ph ph-x text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- 画板输入 -->
                <div id="input-canvas" class="hidden border border-slate-300 rounded-xl overflow-hidden bg-slate-50">
                    <canvas id="drawing-board" width="800" height="300" class="cursor-crosshair w-full bg-white"></canvas>
                    <div class="bg-slate-100 p-2 flex justify-between items-center border-t border-slate-200">
                        <div class="flex gap-2 text-sm">
                            <button onclick="clearCanvas()" class="text-red-500 hover:text-red-700">清空</button>
                        </div>
                        <button onclick="sendCanvas()" class="bg-indigo-600 text-white px-4 py-1 rounded-lg text-sm hover:bg-indigo-700">发送画图</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const conversationId = "{{ conversation.id }}";
    let isWaiting = false;

    // Scroll to bottom
    const chatContainer = document.getElementById('chat-messages');
    chatContainer.scrollTop = chatContainer.scrollHeight;

    function switchTab(tab) {
        // Fix: Only hide content containers, not the main input-area
        document.getElementById('input-text').classList.add('hidden');
        document.getElementById('input-canvas').classList.add('hidden');
        
        document.querySelectorAll('[id^="tab-"]').forEach(el => {
            el.classList.remove('bg-indigo-100', 'text-indigo-700');
            el.classList.add('text-slate-600', 'hover:bg-slate-100');
        });

        document.getElementById(`input-${tab}`).classList.remove('hidden');
        const btn = document.getElementById(`tab-${tab}`);
        if (btn) {
            btn.classList.remove('text-slate-600', 'hover:bg-slate-100');
            btn.classList.add('bg-indigo-100', 'text-indigo-700');
        }
    }

    // --- Drag and Drop Logic ---
    const dropZone = document.body; // Use body to catch drag anywhere
    const dragOverlay = document.getElementById('drag-overlay');
    let dragCounter = 0;

    dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {
            dragOverlay.classList.remove('hidden');
        }
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter === 0) {
            dragOverlay.classList.add('hidden');
        }
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        dragOverlay.classList.add('hidden');

        const files = e.dataTransfer.files;
        if (files && files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                // Manually set files to input
                const fileInput = document.getElementById('image-upload');
                
                // Use DataTransfer to set files property of input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Trigger preview
                previewImage(fileInput);
                
                // Switch to text tab if not already
                switchTab('text');
            } else {
                alert('请上传图片文件');
            }
        }
    });

    // --- Image Upload Logic ---
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearImagePreview() {
        document.getElementById('image-upload').value = '';
        document.getElementById('image-preview').src = '';
        document.getElementById('image-preview-container').classList.add('hidden');
    }

    async function sendMessage() {
        if (isWaiting) return;
        const input = document.getElementById('message-input');
        const fileInput = document.getElementById('image-upload');
        const text = input.value.trim();
        const file = fileInput.files[0];
        
        if (!text && !file) return;

        // UI Update
        let imageUrl = null;
        if (file) {
            // Create a temporary object URL for immediate display
            imageUrl = URL.createObjectURL(file);
        }
        appendUserMessage(text, imageUrl);
        
        input.value = '';
        clearImagePreview(); // Clear preview after sending
        showLoading();

        try {
            const formData = new FormData();
            formData.append('conversation_id', conversationId);
            formData.append('query', text);
            if (file) {
                formData.append('image', file);
            }

            const response = await fetch('{% url "api_send_message" %}', {
                method: 'POST',
                // headers: { 'Content-Type': 'multipart/form-data' }, // Do NOT set this manually for FormData
                body: formData
            });
            console.log("Sending message...", text); // Debug
            const data = await response.json();
            console.log("Response received:", data); // Debug
            
            hideLoading();
            if (data.status === 'success') {
                appendAgentMessage(data.answer, data.image_url, data.desmos_latex);
                if (data.answer.includes('<FINAL_REVIEW>')) {
                    handleFinalReview(data.answer);
                }
            } else {
                alert('出错啦：' + data.message);
            }
        } catch (e) {
            hideLoading();
            console.error(e);
            alert('网络错误');
        }
    }

    function appendUserMessage(text, imageUrl=null) {
        const div = document.createElement('div');
        div.className = 'flex gap-4 flex-row-reverse animate-fade-in-up';
        
        let contentHtml = '';
        if (imageUrl) {
            contentHtml += `<div class="mb-2"><img src="${imageUrl}" class="rounded-lg max-h-48 border border-indigo-400"></div>`;
        }
        if (text) {
            contentHtml += `<p>${text.replace(/\n/g, '<br>')}</p>`;
        }
        
        div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 flex-shrink-0">
                <i class="ph-fill ph-user text-2xl"></i>
            </div>
            <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none max-w-2xl">
                ${contentHtml}
            </div>
        `;
        chatContainer.insertBefore(div, document.getElementById('loading-indicator'));
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendAgentMessage(text, imageUrl, desmosLatex=null) {
        // 去除 potential XML tags visible to user if any
        let cleanText = text ? text.replace(/<FINAL_REVIEW>[\s\S]*?<\/FINAL_REVIEW>/g, '') : '';
        
        const div = document.createElement('div');
        div.className = 'flex gap-4 animate-fade-in-up';
        
        let contentHtml = '';
        
        if (imageUrl) {
            contentHtml += `
                <div class="mb-4">
                    <img src="${imageUrl}" class="rounded-xl shadow-lg border border-indigo-100 max-w-full bg-slate-100 min-h-[200px]" alt="AI Generated Thought Image" loading="lazy" referrerpolicy="no-referrer" onload="scrollToBottom()">
                </div>
            `;
        }

        if (desmosLatex) {
            // Generate unique ID for calculator container
            const calcId = 'desmos-' + Math.random().toString(36).substr(2, 9);
            contentHtml += `
                <div class="mb-4">
                    <div id="${calcId}" style="width: 100%; height: 400px; border: 1px solid #e2e8f0; border-radius: 12px;"></div>
                </div>
            `;
            // Defer initialization
            setTimeout(() => {
                const elt = document.getElementById(calcId);
                if (elt) {
                    if (typeof Desmos === 'undefined') {
                        elt.innerHTML = '<div class="flex items-center justify-center h-full text-red-500 bg-red-50 rounded-lg p-4 text-center"><p>Desmos API 加载失败。<br>请联系管理员配置有效的 DESMOS_API_KEY。</p></div>';
                        return;
                    }
                    const calculator = Desmos.GraphingCalculator(elt, {
                        expressions: false,
                        lockViewport: false
                    });
                    calculator.setExpression({ latex: desmosLatex });
                }
            }, 100);
        }
        
        if (cleanText && cleanText.trim()) {
            contentHtml += `
                <div class="prose prose-slate break-words max-w-none prose-p:my-0 prose-headings:my-1 leading-normal ai-message-content">${marked.parse(cleanText)}</div>
            `;
        }
        
        div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                <i class="ph-fill ph-robot text-2xl"></i>
            </div>
            <div class="bg-slate-100 p-4 rounded-2xl rounded-tl-none max-w-2xl">
                ${contentHtml}
            </div>
        `;
        
        if (!contentHtml) return; // 什么都没有就不显示

        chatContainer.insertBefore(div, document.getElementById('loading-indicator'));
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function scrollToBottom() {
        // 立即滚动
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // 延迟再次滚动，以防布局变化（如图片加载撑开高度）
        setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
        
        setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 300);
    }

    function showLoading() {
        document.getElementById('loading-indicator').classList.remove('hidden');
        isWaiting = true;
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideLoading() {
        document.getElementById('loading-indicator').classList.add('hidden');
        isWaiting = false;
    }

    function handleFinalReview(fullText) {
        // 隐藏输入框
        document.getElementById('input-area').classList.add('translate-y-full');
        
        try {
            const jsonStr = fullText.split('<FINAL_REVIEW>')[1].split('</FINAL_REVIEW>')[0];
            const data = JSON.parse(jsonStr);
            
            const container = document.getElementById('final-review-container');
            container.classList.remove('hidden');
            
            // 渲染时间轴
            let stepsHtml = data.thinking_path.map((step, idx) => `
                <div class="relative pl-8 pb-8 border-l-2 border-indigo-200 last:border-0 last:pb-0">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-600 border-4 border-white"></div>
                    <div class="mb-1 text-sm text-indigo-600 font-bold uppercase tracking-wider">${step.stage}</div>
                    <div class="text-slate-700 bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                        ${step.description}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="mt-8 mb-12">
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-8 rounded-3xl border border-indigo-100">
                        <h2 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">
                            <i class="ph-fill ph-confetti text-3xl text-indigo-600"></i>
                            <span>思考旅程回顾</span>
                        </h2>
                        
                        <div class="mb-8">
                            <h3 class="font-bold text-slate-700 mb-2">你的思维路径：</h3>
                            <div class="ml-2">
                                ${stepsHtml}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border-l-4 border-amber-400 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i class="ph-fill ph-lightbulb text-amber-500 text-xl"></i>
                                <span>导师建议</span>
                            </h3>
                            <p class="text-slate-600 italic">"${data.advice}"</p>
                        </div>

                         <div class="mt-8 text-center">
                            <a href="{% url 'index' %}" class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">完成思考</a>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (e) {
            console.error("Parse review failed", e);
        }
    }

    // --- Voice Input Logic ---
    let recognition;
    let isRecording = false;
    let originalText = '';

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isRecording = true;
            document.getElementById('voice-text').innerText = '聆听中...';
            document.getElementById('btn-voice').classList.add('bg-red-100', 'text-red-600', 'animate-pulse');
            
            // 确保切换到文字 Tab，以便用户看到输入过程
            switchTab('text');
            // 记录当前输入框内容
            const input = document.getElementById('message-input');
            originalText = input.value;
        };

        recognition.onend = () => {
            isRecording = false;
            document.getElementById('voice-text').innerText = '语音';
            document.getElementById('btn-voice').classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
        };

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');
            
            // 将结果实时填入输入框
            const input = document.getElementById('message-input');
            input.value = originalText + transcript;
            
            // 自动调整高度
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        };
        
        recognition.onerror = (event) => {
             console.error("Speech recognition error", event.error);
             isRecording = false;
             document.getElementById('voice-text').innerText = '语音';
             document.getElementById('btn-voice').classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
             // alert("语音识别出错: " + event.error); // 忽略一些常见的错误如 'no-speech'
        };
    } else {
        document.getElementById('btn-voice').style.display = 'none';
        console.warn("Browser does not support Speech API");
    }

    function toggleRecording() {
        if (!recognition) {
            alert("您的浏览器不支持语音输入");
            return;
        }

        if (isRecording) {
            recognition.stop();
        } else {
            // 开始录音时，确保切回文本输入界面
            switchTab('text');
            
            // 启动识别
            try {
                recognition.start();
            } catch (e) {
                console.error("Start error:", e);
            }
        }
    }

    // --- Auto Retry Logic ---
    function handleChatKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // 阻止默认换行
            // 确保在移动端输入法候选词状态下不会误触（虽然 Enter 通常不会触发）
            if (e.isComposing) return;
            sendMessage();
        }
    }

    // Check if the last message is from user (meaning AI failed to respond or user refreshed)
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Render Markdown for existing AI messages
        document.querySelectorAll('.ai-message-content').forEach(el => {
            // 获取原始文本（去除多余空白，但 marked 需要保留换行）
            const rawText = el.textContent.trim();
            if (rawText) {
                el.innerHTML = marked.parse(rawText);
            }
        });

        // Simple check: is the last element a user message?
        // We can check the DOM structure. User messages have flex-row-reverse.
        const messages = document.getElementById('chat-messages').children;
        // Filter out hidden elements like loading-indicator and final-review-container
        const visibleMessages = Array.from(messages).filter(el => 
            !el.id && el.classList.contains('flex')
        );
        
        if (visibleMessages.length > 0) {
            const lastMsg = visibleMessages[visibleMessages.length - 1];
            // User message bubble has 'flex-row-reverse' class
            if (lastMsg.classList.contains('flex-row-reverse')) {
                console.log("Last message is from user. Triggering auto-retry...");
                showLoading();
                
                try {
                    const response = await fetch('{% url "api_retry_last_message" %}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ conversation_id: conversationId })
                    });
                    const data = await response.json();
                    
                    hideLoading();
                    
                    if (data.status === 'success') {
                        appendAgentMessage(data.answer, data.image_url, data.desmos_latex);
                        if (data.answer.includes('<FINAL_REVIEW>')) {
                            handleFinalReview(data.answer);
                        }
                    } else if (data.status === 'no_need_to_retry') {
                        console.log("Server said no need to retry.");
                    }
                } catch (e) {
                    console.error("Auto retry failed", e);
                    hideLoading();
                }
            }
        }
    });

    // --- Canvas Logic ---
    const canvas = document.getElementById('drawing-board');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Resize canvas properly
    function resizeCanvas() {
        const parent = canvas.parentElement;
        if (parent && parent.clientWidth > 0) {
           // canvas.width = parent.clientWidth; // Simple resize resets content, ignore for MVP
        }
    }

    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = '#4f46e5';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function sendCanvas() {
        // Convert canvas to base64 and send (Simplified for MVP: send as text desc or upload)
        // For now, let's just convert to dataURL and put in img tag for user preview
        // And send a special text to backend "[用户上传了一张思维导图]"
        
        const dataURL = canvas.toDataURL();
        
        // Show in chat
        const div = document.createElement('div');
        div.className = 'flex gap-4 flex-row-reverse animate-fade-in-up';
        div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 flex-shrink-0">
                <i class="ph-fill ph-user text-2xl"></i>
            </div>
            <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none max-w-2xl">
                <img src="${dataURL}" class="rounded-lg bg-white">
            </div>
        `;
        chatContainer.insertBefore(div, document.getElementById('loading-indicator'));
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Reset
        clearCanvas();
        switchTab('text');
        
        // Actual send
        // Note: Real implementation should upload file. Here we just send text trigger.
        // In a real app, you'd upload the Blob to the server.
        sendMessageInternal("[用户上传了一张思维草图，请基于此进行分析]");
    }
    
    async function sendMessageInternal(text) {
         showLoading();
         try {
            console.log("Sending internal message...", text); // Debug
            const response = await fetch('{% url "api_send_message" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversation_id: conversationId,
                    query: text
                })
            });
            const data = await response.json();
            console.log("Internal Response received:", data); // Debug
            hideLoading();
            if (data.status === 'success') {
                appendAgentMessage(data.answer, data.image_url, data.desmos_latex);
                 if (data.answer.includes('<FINAL_REVIEW>')) {
                    handleFinalReview(data.answer);
                }
            }
         } catch(e) {
             console.error("Internal send error:", e);
             hideLoading();
         }
    }

    async function deleteConversation(id, event) {
        event.preventDefault(); // 阻止链接跳转
        if (!confirm('确定要删除这条思考记录吗？')) return;

        try {
            const response = await fetch(`/chat/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });
            const data = await response.json();
            if (data.status === 'success') {
                // 如果删除的是当前对话，跳转到新对话
                if (id == conversationId) {
                    window.location.href = "{% url 'chat_new' %}";
                } else {
                    // 找到对应的 DOM 元素并移除，而不是刷新页面
                    const btn = event.target.closest('button');
                    const item = btn.closest('.group');
                    if (item) {
                        item.remove();
                    }
                }
            } else {
                alert('删除失败');
            }
        } catch (e) {
            console.error(e);
            alert('网络错误');
        }
    }
</script>
{% endblock %}
