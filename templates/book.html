{% extends 'base.html' %}

{% block footer %}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Desmos API -->
<script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey={{ desmos_api_key }}"></script>

<div class="flex h-[calc(100vh-64px)] bg-slate-100 overflow-hidden relative">
    
    <!-- 左侧：历史记录 (仅在大屏显示) -->
    <div class="w-64 bg-white border-r border-slate-200 hidden lg:flex flex-col z-10 shadow-sm transition-all duration-300" id="sidebar">
        <div class="p-4 border-b border-slate-200 flex justify-between items-center">
            <h2 class="font-bold text-slate-700">思考记录</h2>
            <a href="{% url 'chat_new' %}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1">
                <i class="ph-bold ph-plus"></i> 新思考
            </a>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-2">
            {% for c in user.conversations.all %}
                <div class="group flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 transition {% if c.id == conversation.id %}bg-indigo-50 border border-indigo-100{% endif %}">
                    <a href="{% url 'chat_detail' c.id %}" class="block flex-1 text-sm text-slate-600 truncate {% if c.id == conversation.id %}font-medium text-indigo-700{% endif %}">
                        {{ c.topic|default:"新思考..." }}
                        <div class="text-xs text-slate-400 mt-1">{{ c.created_at|date:"m-d H:i" }}</div>
                    </a>
                    <button onclick="deleteConversation({{ c.id }}, event)" class="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- 中间：书籍容器 -->
    <div class="flex-1 flex flex-col items-center justify-center p-4 md:p-8 relative transition-all duration-500" id="main-content">
        
        <!-- 全屏开关 -->
        <button onclick="toggleFullscreen()" class="absolute top-4 right-4 z-50 p-2 bg-white/80 backdrop-blur text-slate-500 hover:text-indigo-600 rounded-full shadow-sm hover:shadow transition" title="全屏沉浸模式">
            <i class="ph-bold ph-arrows-out-simple text-xl" id="fullscreen-icon"></i>
        </button>

        <!-- 书籍卡片 -->
        <div class="w-full max-w-3xl bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden flex flex-col transition-all duration-500 ease-in-out relative h-[85vh]" id="book-container">
            
            <!-- 页眉：进度与状态 -->
            <div class="h-14 border-b border-slate-100 flex items-center justify-between px-6 bg-white/80 backdrop-blur-sm z-20">
                <div class="flex items-center gap-2 text-slate-500 text-sm">
                    <i class="ph-fill ph-book-bookmark text-indigo-500"></i>
                    <span id="page-indicator">第 1 页</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="thinking-status" class="hidden text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded-full animate-pulse">
                        思考中...
                    </span>
                </div>
            </div>

            <!-- 书页内容区 (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-8 md:p-12 scroll-smooth relative" id="book-content">
                
                <!-- 欢迎页 (Page 0) -->
                <div id="page-welcome" class="book-page active flex flex-col justify-center items-center h-full text-center space-y-6 animate-fade-in">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-4 shadow-inner">
                        <i class="ph-duotone ph-brain text-5xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800">开始一次深度思考</h1>
                    <p class="text-slate-600 max-w-md mx-auto leading-relaxed">
                        在这个快节奏的时代，慢下来是种奢侈。<br>
                        我不会直接给你答案，但我会陪你一起找到它。
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left mt-8 w-full max-w-2xl">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <i class="ph-fill ph-prohibit text-red-400 text-xl mb-2"></i>
                            <h3 class="font-bold text-slate-700 text-sm">拒绝直给</h3>
                            <p class="text-xs text-slate-500 mt-1">没有标准答案，只有思维线索。</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <i class="ph-fill ph-eye text-indigo-400 text-xl mb-2"></i>
                            <h3 class="font-bold text-slate-700 text-sm">视觉引导</h3>
                            <p class="text-xs text-slate-500 mt-1">用图像和模型激发你的直觉。</p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <i class="ph-fill ph-pencil-simple text-amber-400 text-xl mb-2"></i>
                            <h3 class="font-bold text-slate-700 text-sm">主动构建</h3>
                            <p class="text-xs text-slate-500 mt-1">结论必须由你自己写下。</p>
                        </div>
                    </div>
                </div>

                <!-- 动态生成的对话页 (Pages 1...N) -->
                <!-- 结构：每页包含 [用户提问] + [AI反馈] -->
                <div id="dynamic-pages">
                    <!-- JS will populate this -->
                </div>

                <!-- 最终报告页 -->
                <div id="page-final" class="book-page hidden flex-col h-full animate-fade-in">
                     <div class="mt-8 mb-12 flex flex-col items-center justify-center h-full">
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-8 rounded-3xl border border-indigo-100 w-full max-w-2xl shadow-sm">
                            <h2 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2 justify-center">
                                <i class="ph-fill ph-confetti text-3xl text-indigo-600"></i>
                                <span>思考旅程回顾</span>
                            </h2>
                            
                            <div id="final-review-content" class="mb-8">
                                <!-- Dynamic content -->
                            </div>
                            
                            <div class="text-center">
                                <a href="{% url 'index' %}" class="inline-block px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">完成思考</a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 页脚：交互区 -->
            <div class="border-t border-slate-100 bg-slate-50 p-6 z-20 transition-all duration-300" id="interaction-area">
                
                <!-- 导航按钮 (仅在浏览历史时显示) -->
                <div id="nav-controls" class="hidden justify-between items-center w-full">
                    <button onclick="prevPage()" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 transition px-4 py-2 rounded-lg hover:bg-slate-200">
                        <i class="ph-bold ph-arrow-left"></i> 上一页
                    </button>
                    
                    <!-- 历史回滚控制区 -->
                    <div id="history-controls" class="hidden items-center gap-2 animate-fade-in">
                         <button onclick="rollbackToCurrentPage()" class="px-4 py-2 bg-amber-50 text-amber-600 hover:bg-amber-100 border border-amber-200 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
                            <i class="ph-bold ph-arrow-u-up-left"></i> 从此处继续
                        </button>
                    </div>

                    <button onclick="nextPage()" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 transition px-4 py-2 rounded-lg hover:bg-slate-200">
                        下一页 <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>

                <!-- 输入框 (仅在最新页显示) -->
                <div id="input-controls" class="w-full max-w-2xl mx-auto transition-all">
                    
                    <!-- 工具栏 Tab -->
                    <div class="flex justify-center gap-4 mb-4">
                        <button onclick="switchInputMode('text')" id="mode-text" class="text-sm font-medium text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full transition-colors">
                            <i class="ph-bold ph-text-t"></i> 文字
                        </button>
                        <button onclick="switchInputMode('canvas')" id="mode-canvas" class="text-sm font-medium text-slate-500 hover:bg-slate-200 px-3 py-1 rounded-full transition-colors">
                            <i class="ph-bold ph-pencil-simple"></i> 画板
                        </button>
                        <button onclick="toggleVoice()" id="mode-voice" class="text-sm font-medium text-slate-500 hover:bg-slate-200 px-3 py-1 rounded-full transition-colors flex items-center gap-1">
                            <i class="ph-bold ph-microphone"></i> <span id="voice-label">语音</span>
                        </button>
                    </div>

                    <!-- 文字输入 -->
                    <div id="input-wrapper-text" class="relative">
                        <textarea id="message-input" rows="1" 
                            class="block w-full rounded-2xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 pr-14 pl-4 py-4 resize-none transition-all" 
                            placeholder="写下你的想法..." 
                            style="min-height: 56px; max-height: 150px;"
                            onkeydown="handleKeydown(event)"></textarea>
                        
                        <!-- 上传图片按钮 -->
                        <button onclick="document.getElementById('image-upload').click()" class="absolute right-12 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                            <i class="ph-bold ph-image text-xl"></i>
                        </button>
                        <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="handleImageUpload(this)">

                        <!-- 发送按钮 -->
                        <button onclick="submitMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors shadow-md hover:shadow-lg transform active:scale-95">
                            <i class="ph-bold ph-paper-plane-right"></i>
                        </button>
                    </div>
                    
                    <!-- Skip Option for Input -->
                    <div class="text-center mt-3">
                         <button onclick="skipPage()" class="text-xs text-slate-400 hover:text-indigo-500 transition flex items-center gap-1 mx-auto">
                            <i class="ph-bold ph-fast-forward"></i> 跳过此步 (不知道/没思路)
                        </button>
                    </div>
                    
                    <!-- 图片预览 -->
                    <div id="image-preview-wrapper" class="hidden mt-2 relative inline-block">
                        <img id="image-preview" class="h-16 w-16 object-cover rounded-lg border border-slate-200 shadow-sm">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm">
                            <i class="ph-bold ph-x text-xs"></i>
                        </button>
                    </div>

                    <!-- 画板输入 -->
                    <div id="input-wrapper-canvas" class="hidden bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-inner">
                        <canvas id="drawing-board" class="w-full bg-white cursor-crosshair touch-none" height="200"></canvas>
                        <div class="bg-slate-50 p-2 flex justify-between items-center border-t border-slate-200">
                            <button onclick="clearCanvas()" class="text-red-500 text-xs font-medium hover:text-red-700 px-2">清空</button>
                            <button onclick="submitCanvas()" class="bg-indigo-600 text-white text-xs px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-sm">发送草图</button>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* 书页切换动画 */
    .book-page {
        display: none;
        width: 100%;
        min-height: 100%;
        flex-direction: column;
    }
    .book-page.active {
        display: flex;
        animation: fadeInPage 0.5s ease-out forwards;
    }
    @keyframes fadeInPage {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* 隐藏滚动条但保留功能 */
    #book-content::-webkit-scrollbar {
        width: 6px;
    }
    #book-content::-webkit-scrollbar-track {
        background: transparent;
    }
    #book-content::-webkit-scrollbar-thumb {
        background-color: #e2e8f0;
        border-radius: 20px;
    }

    /* Fullscreen Mode Styles */
    body.fullscreen-mode #sidebar {
        display: none !important;
    }
    body.fullscreen-mode header { /* Assuming header exists in base.html */
        display: none !important;
    }
    body.fullscreen-mode .h-\[calc\(100vh-64px\)\] {
        height: 100vh !important;
    }
    body.fullscreen-mode #main-content {
        padding: 0 !important;
        background-color: #f8fafc; /* Slate-50 background for immersion */
    }
    body.fullscreen-mode #book-container {
        max-width: 1000px; /* Wider book */
        height: 95vh;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border-radius: 2px; /* Sharper corners like a real book? Or keep round. Keep round. */
    }
    /* Add book spine effect in fullscreen */
    body.fullscreen-mode #book-container::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 12px;
        background: linear-gradient(to right, rgba(0,0,0,0.05), rgba(0,0,0,0));
        z-index: 50;
        pointer-events: none;
    }
</style>

<script>
    // --- Fullscreen Logic ---
    function toggleFullscreen() {
        const body = document.body;
        const icon = document.getElementById('fullscreen-icon');
        
        if (!document.fullscreenElement) {
            // Enter fullscreen
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
            body.classList.add('fullscreen-mode');
            icon.classList.remove('ph-arrows-out-simple');
            icon.classList.add('ph-arrows-in-simple');
        } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
            body.classList.remove('fullscreen-mode');
            icon.classList.remove('ph-arrows-in-simple');
            icon.classList.add('ph-arrows-out-simple');
        }
    }
    
    // Listen for Escape key or other exit methods
    document.addEventListener('fullscreenchange', () => {
        const body = document.body;
        const icon = document.getElementById('fullscreen-icon');
        if (!document.fullscreenElement) {
            body.classList.remove('fullscreen-mode');
            icon.classList.remove('ph-arrows-in-simple');
            icon.classList.add('ph-arrows-out-simple');
        }
    });

    // --- State Management ---
    const conversationId = "{{ conversation.id }}";
    let historyData = []; // To store chat history
    let currentPage = 0; // 0 = Welcome, 1+ = Conversation turns
    let totalPages = 0;
    let isWaiting = false;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load initial data from template (interactions)
        const rawInteractions = [
            {% for i in interactions %}
            {
                type: "{{ i.type }}",
                text: `{{ i.text_content|escapejs }}`,
                image: "{{ i.image_url|default:'' }}",
                id: {{ i.id }}
            },
            {% endfor %}
        ];
        
        processHistory(rawInteractions);
        renderPage(currentPage);
        resizeCanvas();
    });

    // --- Book Logic ---
    
    function processHistory(raw) {
        // 将线性交互流转换为“回合制”页面数据
        // 规则：一个 Page = [User Message] + [AI Feedback]
        // Welcome page is Page 0
        
        historyData = [];
        let currentTurn = { user: null, ai: null };
        
        raw.forEach(item => {
            if (['question', 'probe_answer', 'user_interpretation'].includes(item.type)) {
                // 如果已经有 user 消息但没有 ai 消息（连续发送），先把之前的存起来（虽然不应该发生）
                if (currentTurn.user && !currentTurn.ai) {
                    // Just overwrite for now or handle multiple user msgs
                }
                // 如果是一个新的回合开始（已有完整回合），推入历史
                if (currentTurn.user && currentTurn.ai) {
                    historyData.push(currentTurn);
                    currentTurn = { user: null, ai: null };
                }
                currentTurn.user = item;
            } else if (['ai_feedback', 'ai_image'].includes(item.type)) {
                if (!currentTurn.user) {
                    // AI 先说话？（除了欢迎语不应该发生）
                    // 也可以作为一个独立回合
                    currentTurn.user = { text: "..." }; // Placeholder
                }
                currentTurn.ai = item;
                // 完成一个回合
                historyData.push(currentTurn);
                currentTurn = { user: null, ai: null };
            }
        });
        
        // 处理最后一个未闭合的回合
        if (currentTurn.user) {
            historyData.push(currentTurn);
        }

        // Page 0 is Welcome
        // Page 1..N are history turns
        totalPages = historyData.length; 
        
        // 如果有历史记录，默认跳到最后一页
        if (totalPages > 0) {
            currentPage = totalPages;
        } else {
            currentPage = 0;
        }
        
        updatePagination();
    }

    function renderPage(pageIdx) {
        // Hide all pages
        document.querySelectorAll('.book-page').forEach(el => el.classList.remove('active'));
        document.getElementById('dynamic-pages').innerHTML = ''; // Clear dynamic container
        
        if (pageIdx === 0 && totalPages === 0) {
            document.getElementById('page-welcome').classList.add('active');
            toggleInputArea(true);
        } else if (pageIdx > 0 && pageIdx <= totalPages) {
            // Render specific turn
            const turn = historyData[pageIdx - 1];
            const pageDiv = document.createElement('div');
            pageDiv.className = 'book-page active space-y-8 animate-fade-in';
            
            // User Section (Top)
            let userHtml = '';
            if (turn.user) {
                userHtml = `
                    <div class="flex gap-4">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0 shadow-sm border border-indigo-50">
                            <i class="ph-bold ph-user text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-slate-400 mb-1 font-medium">你的思考</div>
                            <div class="bg-white border border-slate-100 p-5 rounded-2xl rounded-tl-none shadow-sm text-slate-700 text-lg leading-relaxed">
                                ${turn.user.image ? `<img src="${turn.user.image}" class="mb-3 rounded-lg max-h-48 border border-slate-100">` : ''}
                                ${marked.parse(turn.user.text || '')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // AI Section (Bottom)
            let aiHtml = '';
            if (turn.ai) {
                // Check for Desmos
                if (turn.ai.desmos) {
                    // Generate unique ID
                    const calcId = 'desmos-' + Math.random().toString(36).substr(2, 9);
                    aiHtml += `
                        <div class="mb-4 pl-14 pr-6">
                            <div id="${calcId}" style="width: 100%; height: 400px; border: 1px solid #e2e8f0; border-radius: 12px;"></div>
                        </div>
                    `;
                    
                    // Initialize later
                    setTimeout(() => {
                        const elt = document.getElementById(calcId);
                        if (elt && typeof Desmos !== 'undefined') {
                            const calculator = Desmos.GraphingCalculator(elt, {
                                expressions: true,
                                lockViewport: false,
                                settingsMenu: false
                            });
                            
                            const latex = turn.ai.desmos;
                            calculator.setExpression({ latex: latex });
                            
                            // Auto-add sliders for parameters a,b,c if not defined
                            ['a', 'b', 'c'].forEach(v => {
                                if (latex.includes(v) && !latex.includes(v + '=')) {
                                    calculator.setExpression({ id: 'slider_' + v, latex: v + '=1' });
                                }
                            });
                            calculator.resize();
                        }
                    }, 100);
                }

                // Clean final review tags
                let cleanText = turn.ai.text.replace(/<FINAL_REVIEW>[\s\S]*?<\/FINAL_REVIEW>/g, '');
                
                // Check for Challenge
                // We use a regex to extract <CHALLENGE>...</CHALLENGE> from text
                // Because we stored it in text_content for persistence
                let challengeData = null;
                const challengeMatch = cleanText.match(/<CHALLENGE>([\s\S]*?)<\/CHALLENGE>/);
                if (challengeMatch) {
                    try {
                        challengeData = JSON.parse(challengeMatch[1]);
                        cleanText = cleanText.replace(/<CHALLENGE>[\s\S]*?<\/CHALLENGE>/, '');
                    } catch(e) { console.error("Challenge parse error", e); }
                }

                // If challenge data is in turn.ai object directly (from live API response)
                if (!challengeData && turn.ai.challenge) {
                    challengeData = turn.ai.challenge;
                }

                aiHtml += `
                    <div class="flex gap-4">
                         <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white flex-shrink-0 shadow-sm">
                            <i class="ph-fill ph-robot text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-slate-400 mb-1 font-medium">导师反馈</div>
                            <div class="bg-slate-50 border border-slate-100 p-6 rounded-2xl rounded-tl-none text-slate-700 leading-relaxed prose prose-slate max-w-none">
                                ${turn.ai.image ? `<img src="${turn.ai.image}" class="mb-4 rounded-xl shadow-md border border-slate-200">` : ''}
                                ${marked.parse(cleanText)}
                                
                                ${challengeData ? renderChallenge(challengeData, pageIdx) : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else if (isWaiting && pageIdx === totalPages) {
                 // Loading state for current latest page
                 aiHtml = `
                    <div class="flex gap-4 opacity-50">
                         <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white flex-shrink-0">
                            <i class="ph-fill ph-robot text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-slate-400 mb-1">思考中...</div>
                            <div class="bg-slate-50 p-6 rounded-2xl rounded-tl-none typing-indicator">
                                <span>.</span><span>.</span><span>.</span>
                            </div>
                        </div>
                    </div>
                 `;
            }

            pageDiv.innerHTML = userHtml + aiHtml;
            document.getElementById('dynamic-pages').appendChild(pageDiv);
            
            // Logic for Input visibility
            // If Challenge exists and NOT solved, HIDE main input?
            // Or let user answer challenge to proceed.
            // Let's hide main input if challenge is active on this page.
            
            // For MVP, we don't strictly block.
            // But visually, the challenge IS the input for this turn.
            
            if (pageIdx === totalPages && turn.ai && !isWaiting) {
                // If there is a challenge, user should interact with it first?
                // But challenge is inside AI bubble.
                // Let's keep main input visible for general replies, 
                // but maybe the challenge interaction sends a message automatically.
                toggleInputArea(true); 
            } else {
                toggleInputArea(false); 
            }
        }
        
        updatePagination();
    }

    function renderChallenge(payload, pageIdx) {
        if (payload.type !== 'fill_in_the_blank') return '';
        const data = payload.data;
        // Escape quotes for HTML attributes
        const question = data.question.replace(/"/g, '&quot;');
        const answer = data.correct_answer.replace(/"/g, '&quot;');
        const hint = (data.hint || '').replace(/"/g, '&quot;');
        const challengeId = `challenge-${pageIdx}`;
        
        // Render UI
        // Replace ___ with <input>
        const parts = question.split('___');
        let html = '<div class="mt-6 bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm">';
        html += '<div class="text-sm font-bold text-indigo-600 mb-2 uppercase tracking-wide">理解力挑战</div>';
        html += '<div class="text-lg text-slate-800 flex flex-wrap items-center gap-2">';
        
        // Simple one-blank support for MVP
        html += parts[0];
        html += `<input type="text" id="${challengeId}-input" class="border-b-2 border-indigo-200 focus:border-indigo-600 outline-none px-2 py-1 w-32 text-center font-bold text-indigo-700 bg-indigo-50 rounded" placeholder="?">`;
        if (parts[1]) html += parts[1];
        
        html += '</div>';
        
        html += `<div class="mt-4 flex items-center gap-3">
            <button onclick="checkChallenge('${challengeId}', '${answer}')" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition shadow-sm">
                验证答案
            </button>
            <span id="${challengeId}-msg" class="text-sm font-medium"></span>
        </div>`;
        
        html += '</div>';
        return html;
    }

    function checkChallenge(id, correctAnswer) {
        const input = document.getElementById(id + '-input');
        const msg = document.getElementById(id + '-msg');
        const userVal = input.value.trim().toLowerCase();
        const correctVal = correctAnswer.trim().toLowerCase();
        
        // Simple fuzzy check (contains)
        if (userVal && (userVal === correctVal || userVal.includes(correctVal) || correctVal.includes(userVal))) {
            msg.className = "text-sm font-medium text-green-600 animate-fade-in";
            msg.innerHTML = '<i class="ph-bold ph-check-circle"></i> 正确！';
            input.classList.add('border-green-500', 'bg-green-50');
            input.disabled = true;
            
            // Auto-send success message to AI to proceed?
            // Or just let user feel good.
            // Let's just let user feel good for now.
        } else {
            msg.className = "text-sm font-medium text-red-500 animate-shake";
            msg.innerHTML = '<i class="ph-bold ph-warning-circle"></i> 不太对，再想想？';
            input.classList.add('border-red-300', 'bg-red-50');
            setTimeout(() => {
                 input.classList.remove('border-red-300', 'bg-red-50');
                 msg.classList.remove('animate-shake');
            }, 1000);
        }
    }

    function updatePagination() {
        const indicator = document.getElementById('page-indicator');
        if (totalPages === 0) {
            indicator.innerText = "序章";
        } else {
            indicator.innerText = `第 ${currentPage} / ${totalPages} 页`;
        }
        
        // Nav buttons visibility
        const nav = document.getElementById('nav-controls');
        
        if (totalPages > 0) {
             nav.classList.remove('hidden');
             nav.classList.add('flex');
        } else {
             nav.classList.add('hidden');
             nav.classList.remove('flex');
        }
        
        // History Controls Visibility
        const historyControls = document.getElementById('history-controls');
        if (historyControls) {
            if (currentPage < totalPages && currentPage > 0) {
                 historyControls.classList.remove('hidden');
                 historyControls.classList.add('flex');
            } else {
                 historyControls.classList.add('hidden');
                 historyControls.classList.remove('flex');
            }
        }
    }

    async function rollbackToCurrentPage() {
        if (!confirm('确定要回到这一步吗？在此之后的所有对话记录将被删除。')) return;
        
        const turn = historyData[currentPage - 1];
        let targetId = null;
        if (turn.ai && turn.ai.id) {
            targetId = turn.ai.id;
        } else if (turn.user && turn.user.id) {
            targetId = turn.user.id;
        }
        
        if (!targetId) {
            alert("无法定位该步骤 ID");
            return;
        }
        
        try {
            const response = await fetch('{% url "api_rollback_conversation" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    conversation_id: conversationId, 
                    interaction_id: targetId 
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                // Slice history locally
                historyData = historyData.slice(0, currentPage);
                totalPages = historyData.length;
                currentPage = totalPages;
                
                // Re-render
                renderPage(currentPage);
            } else {
                alert("回退失败: " + data.message);
            }
        } catch(e) {
            console.error(e);
            alert("请求失败");
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
        } else if (currentPage === 1) {
             // Go to welcome? Maybe not necessary once started.
        }
    }
    
    // --- Skip Logic ---
    function skipPage() {
        if (!confirm('确定要跳过这一步吗？AI 将自动为你生成一个过渡回复。')) return;
        
        // Mock skipping: Send a "skip" signal
        sendMessageInternal("我不知道，请直接告诉我下一步");
    }

    function toggleInputArea(show) {
        const inputDiv = document.getElementById('input-controls');
        const navDiv = document.getElementById('nav-controls');
        
        if (show) {
            inputDiv.classList.remove('hidden');
            inputDiv.classList.add('block');
            
            // If we have history (more than 1 page), show nav even if input is active
            // This allows user to go back to history from the latest page
            if (totalPages > 0) {
                 navDiv.classList.remove('hidden');
                 navDiv.classList.add('flex');
            } else {
                 navDiv.classList.add('hidden'); 
                 navDiv.classList.remove('flex');
            }

        } else {
            inputDiv.classList.add('hidden');
            inputDiv.classList.remove('block');
            
            // If history exists, show nav
            if (totalPages > 0) {
                navDiv.classList.remove('hidden');
                navDiv.classList.add('flex');
            }
        }
    }

    // --- Input Handling ---

    function switchInputMode(mode) {
        // Reset styles
        ['text', 'canvas', 'voice'].forEach(m => {
            const btn = document.getElementById(`mode-${m}`);
            btn.classList.remove('bg-indigo-100', 'text-indigo-600');
            btn.classList.add('text-slate-500', 'hover:bg-slate-200');
        });
        
        // Active style
        const activeBtn = document.getElementById(`mode-${mode}`);
        activeBtn.classList.remove('text-slate-500', 'hover:bg-slate-200');
        activeBtn.classList.add('bg-indigo-100', 'text-indigo-600');
        
        // Show/Hide containers
        if (mode === 'text' || mode === 'voice') {
            document.getElementById('input-wrapper-text').classList.remove('hidden');
            document.getElementById('input-wrapper-canvas').classList.add('hidden');
        } else if (mode === 'canvas') {
            document.getElementById('input-wrapper-text').classList.add('hidden');
            document.getElementById('input-wrapper-canvas').classList.remove('hidden');
            resizeCanvas();
        }
    }
    
    async function submitMessage() {
        const input = document.getElementById('message-input');
        const fileInput = document.getElementById('image-upload');
        const text = input.value.trim();
        const file = fileInput.files[0];

        if (file && file.size > 10 * 1024 * 1024) {
            alert('图片太大啦！请上传小于 10MB 的图片。');
            return;
        }
        if (!text && !file) return;

        // 1. Add new turn to history immediately for optimistic UI
        let imageUrl = null;
        if (file) imageUrl = URL.createObjectURL(file);
        
        const newTurn = {
            user: { text: text, image: imageUrl },
            ai: null // Waiting
        };
        historyData.push(newTurn);
        totalPages++;
        currentPage = totalPages;
        
        // 2. Render Waiting State
        isWaiting = true;
        renderPage(currentPage);
        
        // 3. Clear Inputs
        input.value = '';
        clearImage();
        
        // 4. Send API
        try {
            const formData = new FormData();
            formData.append('conversation_id', conversationId);
            formData.append('query', text);
            if (file) formData.append('image', file);
            
            // Show status
            document.getElementById('thinking-status').classList.remove('hidden');

            const response = await fetch('{% url "api_send_message" %}', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) throw new Error(response.status);
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update history with AI response
                historyData[totalPages - 1].ai = {
                    text: data.answer,
                    image: data.image_url,
                    desmos: data.desmos_latex
                };
                isWaiting = false;
                document.getElementById('thinking-status').classList.add('hidden');
                renderPage(currentPage);
                
                // Final review check
                if (data.answer.includes('<FINAL_REVIEW>')) {
                    // Navigate to final page? 
                    // Or just render it in the AI bubble?
                    // Let's render in bubble for now as configured in renderPage
                }
            } else {
                throw new Error(data.message);
            }
        } catch (e) {
            alert("发送失败: " + e.message);
            isWaiting = false;
            // Remove the failed turn? Or show error state?
            // For MVP: keep user msg, leave AI empty or show error
            historyData.pop(); 
            totalPages--;
            currentPage = totalPages;
            renderPage(currentPage);
        }
    }

    function handleKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitMessage();
        }
    }
    
    // --- Delete Conversation ---
    async function deleteConversation(id, event) {
        event.preventDefault();
        event.stopPropagation();
        
        if (!confirm('确定要删除这条思考记录吗？')) return;
        
        try {
            const response = await fetch(`/chat/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                if (id == conversationId) {
                    window.location.href = "{% url 'chat_new' %}";
                } else {
                    const btn = event.target.closest('button');
                    if (btn) {
                        const group = btn.closest('.group');
                        if (group) group.remove();
                    }
                }
            } else {
                alert('删除失败');
            }
        } catch(e) {
            console.error(e);
            alert('删除出错');
        }
    }
    
    // --- Helpers (Image, Canvas, Voice) ---
    // (Copy existing logic from chat.html but adapted to new IDs)
    
    function handleImageUpload(input) {
             const file = input.files[0];
             if (file.size > 10 * 1024 * 1024) {
                alert('图片太大啦！');
                input.value = '';
                return;
            }
            document.getElementById('image-preview').src = URL.createObjectURL(file);
            document.getElementById('image-preview-wrapper').classList.remove('hidden');
        }
    }
    
    function clearImage() {
        document.getElementById('image-upload').value = '';
        document.getElementById('image-preview-wrapper').classList.add('hidden');
    }

    // Canvas
    const canvas = document.getElementById('drawing-board');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0, lastY = 0;
    
    function resizeCanvas() {
        const parent = canvas.parentElement;
        if (parent) {
             canvas.width = parent.clientWidth;
             canvas.height = 200; // Fixed height
        }
    }
    
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = '#4f46e5';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    canvas.addEventListener('mouseup', () => isDrawing = false);
    
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    function submitCanvas() {
        const dataURL = canvas.toDataURL();
        // Create a blob/file from dataURL for upload simulation
        // For MVP, just send text trigger
        // Reusing submitMessage logic is tricky because we need to switch input modes.
        // Let's manually trigger history push
        
        const newTurn = {
            user: { text: "[手绘草图]", image: dataURL },
            ai: null
        };
        historyData.push(newTurn);
        totalPages++;
        currentPage = totalPages;
        isWaiting = true;
        renderPage(currentPage);
        clearCanvas();
        switchInputMode('text'); // Reset to text
        
        // Send API (Mocking text trigger)
         sendMessageInternal("[用户上传了一张思维草图，请基于此进行分析]");
    }
    
    async function sendMessageInternal(text) {
        // Reuse logic... (omitted for brevity, similar to submitMessage)
        // ...
        // Need to duplicate fetch logic or refactor.
        // For quick implementation:
        try {
            document.getElementById('thinking-status').classList.remove('hidden');
            const response = await fetch('{% url "api_send_message" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversation_id: conversationId, query: text })
            });
            const data = await response.json();
            if (data.status === 'success') {
                historyData[totalPages - 1].ai = {
                    text: data.answer,
                    image: data.image_url,
                    desmos: data.desmos_latex
                };
                isWaiting = false;
                document.getElementById('thinking-status').classList.add('hidden');
                renderPage(currentPage);
            }
        } catch(e) {
            console.error(e);
            isWaiting = false;
        }
    }
    
    // Voice
    let voiceRec;
    let isVoiceOn = false;
    
    function toggleVoice() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("浏览器不支持语音");
            return;
        }
        
        if (isVoiceOn) {
            voiceRec.stop();
            isVoiceOn = false;
            document.getElementById('voice-label').innerText = "语音";
            document.getElementById('mode-voice').classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
        } else {
            voiceRec = new webkitSpeechRecognition();
            voiceRec.lang = 'zh-CN';
            voiceRec.continuous = true;
            voiceRec.interimResults = true;
            
            voiceRec.onstart = () => {
                isVoiceOn = true;
                document.getElementById('voice-label').innerText = "聆听中...";
                document.getElementById('mode-voice').classList.add('bg-red-100', 'text-red-600', 'animate-pulse');
                switchInputMode('text');
            };
            
            voiceRec.onresult = (event) => {
                 const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');
                document.getElementById('message-input').value = transcript;
            };
            
            voiceRec.start();
        }
    }

</script>
{% endblock %}